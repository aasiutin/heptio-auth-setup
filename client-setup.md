# Kubernetes Production cluster authentication setup

This guide describes how to authenticate to Kubernetes cluster using kubectl and auth token generated by heptio-authenticator. If you're interested in configuring Kubernetes authentication on server side please refer [this guide](server-setup.md)

Authentication is performed via your AWS credentials. So your local laptop should be configured properly (if you have aws cli tool installed and working properly you should be okay with that). Otherwise please see [this documentation page](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html) from AWS.

First and foremost, you should ask AWS infra-team engineers to add you to proper AWS IAM Group (your access permissions will depens on this).

Install  `kubectl` tool. You can do this with brew for example

```
brew install kubernetes-cli
```

Please download `get_token` binary and save it somewhere (i.e. to `~/.kube/get_token`)

```
aws s3 cp s3://tup-devops/get_token .
mv get_token ~/.kube/get_token
chmod +x ~/.kube/get_token
```

`get_token` binary was compiled for OSX from this repo. If you're going to use it on Linux or Windows you should compile binary by yourself (or please contact infra-team for help).

You should add kubectl green cluster config. If you don't have any servers added to your kubeconfig ( you can simply check this executing `cat ~/.kube/config`) you can just substitute your `~/.kube/config` file with the next YAML:

```
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: CERTIFICATE GOES HERE
    server: https://cluster-url.example.com
  name: cluster-url.example.com
contexts:
- context:
    cluster: cluster-url.example.com
    user: cluster-url.example.com
  name: cluster-url.example.com
current-context: cluster-url.example.com
kind: Config
preferences: {}
users:
```

Otherwise please add the next cluster data to clusters section

```
- cluster:
    certificate-authority-data: CERTIFICATE GOES HERE
    server: https://cluster-url.example.com
  name: cluster-url.example.com
```

and the next context data to contexts section

```
- context:
    cluster: cluster-url.example.com
    user: cluster-url.example.com
  name: cluster-url.example.com
```

After that you're all setup. Please switch kubectl context to green cluster

```
kubectl config use-context cluster-url.example.com
```

Then please check that `get_token` binary generates auth token properly

```
~/.kube/get_token
```

You should see something like this as an output:
```
k8s-aws-v1.aHR0cHM6Ly9zdHMuYW1hem9uYLmNvbS8_QWN0aW9uPUdldENhbGxlcklkZW50aXR5JlZlcnNpb249MjAxMxNSZYLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUUFKNjYyNDJFM0lXMjVBRkZBJTxODAzMjIlMkZ1cy1lYXN0LTElMkZzMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDE4MlQwODI1NDdaJlgtQW16LUV4cGlyZXM9NjAmWC1BbXotU2VjdXJpdHktVG9rZW49RlFvRFlYZHpFQklhREtFM1k3
```

Now please execute

```kubectl version --token=$(~/.kube/get_token)```

If everythins is correct you should be able to see both client and server versions. From now you should add `--token` param to all your kubectl commands. For convenience you can create the next alias (and maybe put it to your `~/.bash_profile`, `~/.zshrc`)

`alias kubectl="kubectl --token=\$(~/.kube/get_token)"`
